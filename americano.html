<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GonaPadel – Live</title>
<style>
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:linear-gradient(135deg,#ff6a00,#ffd200,#fff);
    margin:0;
    padding:24px;
  }
  .wrap{
    max-width:800px;
    margin:0 auto;
    background:rgba(255,255,255,.9);
    border-radius:16px;
    padding:20px;
    box-shadow:0 12px 30px rgba(0,0,0,.1);
  }
  h1{
    margin:0 0 4px;
    font-size:22px;
  }
  .sub{
    color:#333;
    opacity:.8;
    margin-bottom:16px;
  }
  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:12px;
    background:#eee;
    font-size:12px;
    margin-right:8px;
  }
  .live{ background:#e6ffec; }

  table{
    width:100%;
    border-collapse:collapse;
    background:#fff;
    border-radius:12px;
    overflow:hidden;
  }
  thead th{
    text-align:left;
    font-size:12px;
    color:#666;
    padding:10px;
    background:#fafafa;
  }
  tbody td{
    padding:12px 10px;
    border-top:1px solid #f0f0f0;
    font-size:14px;
  }
  .right{text-align:right;}
  .pm{font-variant-numeric:tabular-nums;}

  .footer{
    margin-top:10px;
    font-size:12px;
    color:#444;
    opacity:.8;
  }
  .err{
    color:#b00020;
    margin-top:10px;
    font-size:12px;
  }

  /* Kierrokset & kenttälista */
  .courts{
    margin-top:16px;
  }
  .round{
    margin-top:14px;
  }
  .round-title{
    font-size:13px;
    font-weight:700;
    margin-bottom:6px;
    color:#222;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .round-check{
    font-size:13px;
    color:#0a8a0a;
  }

  .court{
    border-radius:10px;
    background:#fafafa;
    padding:10px 12px;
    margin-bottom:8px;
    border:1px solid #eee;
  }
  .court-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:4px;
  }
  .court-title{
    font-size:13px;
    font-weight:600;
    color:#333;
  }
  .court-score{
    font-size:13px;
    font-weight:600;
    color:#111;
    font-variant-numeric:tabular-nums;
  }
  .court-teams{
    font-size:13px;
    color:#444;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    align-items:center;
  }
  .court-teams span{
    white-space:nowrap;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1 id="title">Ladataan…</h1>
  <div class="sub">
    <span id="meta" class="badge">–</span>
    <span id="state" class="badge live">Live</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Pelaaja</th>
        <th class="right">Pisteet</th>
        <th class="right">±</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <!-- Kierrokset & kentät -->
  <div class="courts" id="courts"></div>

  <div class="footer" id="updated">Päivitetty: –</div>
  <div class="err" id="err"></div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL  = "https://bxklcpvwtaeklormsdsk.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4a2xjcHZ3dGFla2xvcm1zZHNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyOTE4MzgsImV4cCI6MjA3ODg2NzgzOH0.bV5-yhGlnHkPBXY_vdirMZjWhPzoiL7OU7txTfexPBA";

  const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

  const id      = new URLSearchParams(location.search).get("id");
  const $title  = document.getElementById("title");
  const $meta   = document.getElementById("meta");
  const $state  = document.getElementById("state");
  const $rows   = document.getElementById("rows");
  const $upd    = document.getElementById("updated");
  const $err    = document.getElementById("err");
  const $courts = document.getElementById("courts");

  if (!id) {
    $title.textContent = "Virhe: puuttuva id";
    throw new Error("no id");
  }

  const getVal = (obj, camel, lower) => (obj?.[camel] ?? obj?.[lower]);

  async function loadOnce(){
    const { data, error } = await sb
      .from("americano")
      .select("*")
      .eq("id", id)
      .maybeSingle();

    if (error) {
      console.error("select error:", error);
      $err.textContent = "Virhe haussa: " + (error.message || String(error));
      return;
    }
    if (!data) {
      $title.textContent = "Turnausta ei löytynyt (id: " + id + ")";
      $rows.innerHTML = "";
      $meta.textContent = "–";
      $state.textContent = "Ei dataa";
      $state.className = "badge";
      $courts.innerHTML = "";
      $upd.textContent = "Päivitetty: –";
      return;
    }
    render(data);
  }

  await loadOnce();

  sb.channel("realtime:americano")
    .on(
      "postgres_changes",
      { event:"*", schema:"public", table:"americano", filter:`id=eq.${id}` },
      (payload) => render(payload.new ?? payload.old)
    )
    .subscribe();

  function render(d){
    if (!d) return;

    const pointsPerRound = getVal(d, "pointsPerRound", "pointsperround");
    const currentRound   = getVal(d, "currentRound",   "currentround");
    const totalRounds    = getVal(d, "totalRounds",    "totalrounds");
    const isFinished     = getVal(d, "isFinished",     "isfinished");
    const updatedAtRaw   = getVal(d, "updatedAt",      "updatedat");

    $title.textContent = d.name || "Americano";
    $meta.textContent  = `Kierros ${currentRound}/${totalRounds} • ${pointsPerRound} p/ottelu`;
    $state.textContent = isFinished ? "Päättynyt" : "Live";
    $state.className   = "badge " + (isFinished ? "" : "live");

    // Pistetaulukko
    const players = (d.players || []).slice()
      .sort((a,b)=> (b.totalPoints||0)-(a.totalPoints||0));

    $rows.innerHTML = players.map(p => `
      <tr>
        <td>${esc(p.name||"-")}</td>
        <td class="right">${p.totalPoints ?? 0}</td>
        <td class="right pm">${esc(p.pm50 || "0")}</td>
      </tr>`
    ).join("");

    // Kaikki kierrokset & kentät
    const matches = getVal(d, "matches", "matches") || [];
    if (!matches || matches.length === 0) {
      $courts.innerHTML = "";
    } else {
      // Ryhmitellään kierroksen mukaan
      const byRound = new Map();
      for (const m of matches) {
        const r = m.round ?? m.roundIndex ?? 0;
        if (!byRound.has(r)) byRound.set(r, []);
        byRound.get(r).push(m);
      }

      const sortedRounds = Array.from(byRound.keys())
        .filter(r => r > 0)
        .sort((a,b) => a - b);

      const html = sortedRounds.map(r => {
        const games = byRound.get(r).slice()
          .sort((a,b) => (a.court ?? 0) - (b.court ?? 0));

        // Onko kierros valmis? (kaikilla scoreA on numero)
        const finished = games.every(m =>
          typeof m.scoreA === "number"
        );

        const gamesHtml = games.map(m => {
          const court = m.court ?? m.courtIndex ?? "?";
          const teamA = (m.teamA || []).join(" & ");
          const teamB = (m.teamB || []).join(" & ");

          let scoreText = "–";
          if (typeof m.scoreA === "number" && typeof m.scoreB === "number") {
            scoreText = `${m.scoreA}–${m.scoreB}`;
          }

          return `
            <div class="court">
              <div class="court-header">
                <div class="court-title">Kenttä ${esc(String(court))}</div>
                <div class="court-score">${esc(scoreText)}</div>
              </div>
              <div class="court-teams">
                <span>${esc(teamA)}</span>
                <span>vs</span>
                <span>${esc(teamB)}</span>
              </div>
            </div>
          `;
        }).join("");

        return `
          <div class="round">
            <div class="round-title">
              <span>Kierros ${r}/${totalRounds}</span>
              ${finished ? '<span class="round-check">✓</span>' : ''}
            </div>
            ${gamesHtml}
          </div>
        `;
      }).join("");

      $courts.innerHTML = html;
    }

    const dt = updatedAtRaw ? new Date(updatedAtRaw) : new Date();
    $upd.textContent = "Päivitetty: " + dt.toLocaleString();
    $err.textContent = "";
  }

  function esc(s){
    return (s??"").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
</script>
</body>
</html>


