<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GonaPadel â€“ Live</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,#ff6a00,#ffd200,#fff);margin:0;padding:24px;}
  .wrap{max-width:800px;margin:0 auto;background:rgba(255,255,255,.9);border-radius:16px;padding:20px;box-shadow:0 12px 30px rgba(0,0,0,.1);}
  h1{margin:0 0 4px;font-size:22px;}
  .sub{color:#333;opacity:.8;margin-bottom:16px;}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:12px;background:#eee;font-size:12px;margin-right:8px;}
  .live{background:#e6ffec;}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;}
  thead th{text-align:left;font-size:12px;color:#666;padding:10px;background:#fafafa;}
  tbody td{padding:12px 10px;border-top:1px solid #f0f0f0;font-size:14px;}
  .right{text-align:right;}
  .pm{font-variant-numeric:tabular-nums;}
  .footer{margin-top:10px;font-size:12px;color:#444;opacity:.8;}
  .err{color:#b00020;margin-top:10px;font-size:12px;}
</style>
</head>
<body>
<div class="wrap">
  <h1 id="title">Ladataanâ€¦</h1>
  <div class="sub">
    <span id="meta" class="badge">â€“</span>
    <span id="state" class="badge live">Live</span>
  </div>
  <table>
    <thead><tr><th>Pelaaja</th><th class="right">Pisteet</th><th class="right">Â±50%</th></tr></thead>
    <tbody id="rows"></tbody>
  </table>
  <div class="footer" id="updated">PÃ¤ivitetty: â€“</div>
  <div class="err" id="err"></div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ðŸ”§ VAIHDA NÃ„MÃ„ OMIIN ARVOIHIN (Settings â†’ API)
  const SUPABASE_URL  = "https://<YOUR-PROJECT-REF>.supabase.co"; // esim. https://bxklcpvwtaeklormsdsk.supabase.co
  const SUPABASE_ANON = "<YOUR-ANON-PUBLIC-KEY>";

  // âœ… Luo asiakas PROJEKTIN URL:lla (EI functions-osoitetta)
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

  const id = new URLSearchParams(location.search).get("id");
  const $title = document.getElementById("title");
  const $meta  = document.getElementById("meta");
  const $state = document.getElementById("state");
  const $rows  = document.getElementById("rows");
  const $upd   = document.getElementById("updated");
  const $err   = document.getElementById("err");

  if (!id) { $title.textContent = "Virhe: puuttuva id"; throw new Error("no id"); }

  // pikkutuki: hae kenttÃ¤ camelCase- tai pienikirjaisena
  const getVal = (obj, camel, lower) => (obj?.[camel] ?? obj?.[lower]);

  async function loadOnce(){
    const { data, error } = await sb.from("americano")
      .select("*")
      .eq("id", id)
      .maybeSingle();

    if (error) {
      console.error("select error:", error);
      $err.textContent = "Virhe haussa: " + (error.message || String(error));
      return;
    }
    if (!data) {
      $title.textContent = "Turnausta ei lÃ¶ytynyt (id: " + id + ")";
      $rows.innerHTML = "";
      $meta.textContent = "â€“";
      $state.textContent = "Ei dataa";
      $state.className = "badge";
      $upd.textContent = "PÃ¤ivitetty: â€“";
      return;
    }
    render(data);
  }
  await loadOnce();

  // Realtime-pÃ¤ivitykset
  sb.channel("realtime:americano")
    .on("postgres_changes", { event: "*", schema: "public", table: "americano", filter: `id=eq.${id}` },
      (payload) => render(payload.new ?? payload.old))
    .subscribe();

  function render(d){
    if (!d) return;

    const pointsPerRound = getVal(d, "pointsPerRound", "pointsperround");
    const currentRound   = getVal(d, "currentRound",   "currentround");
    const totalRounds    = getVal(d, "totalRounds",    "totalrounds");
    const isFinished     = getVal(d, "isFinished",     "isfinished");
    const updatedAtRaw   = getVal(d, "updatedAt",      "updatedat");

    $title.textContent = d.name || "Americano";
    $meta.textContent  = `Kierros ${currentRound}/${totalRounds} â€¢ ${pointsPerRound} p/ottelu`;
    $state.textContent = isFinished ? "PÃ¤Ã¤ttynyt" : "Live";
    $state.className   = "badge " + (isFinished ? "" : "live");

    const players = (d.players || []).slice().sort((a,b)=> (b.totalPoints||0)-(a.totalPoints||0));
    $rows.innerHTML = players.map(p => `
      <tr>
        <td>${esc(p.name||"-")}</td>
        <td class="right">${p.totalPoints ?? 0}</td>
        <td class="right pm">${esc(p.pm50 || "0")}</td>
      </tr>`
    ).join("");

    const dt = updatedAtRaw ? new Date(updatedAtRaw) : new Date();
    $upd.textContent = "PÃ¤ivitetty: " + dt.toLocaleString();
    $err.textContent = "";
  }

  function esc(s){
    return (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
</script>
</body>
</html>

