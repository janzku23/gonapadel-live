<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mexicano Live â€“ GonaPadel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: linear-gradient(135deg, #ff5252, #ffd54f, #ffffff);
      min-height: 100vh;
      color: #111;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 900px;
      width: 100%;
      padding: 16px;
    }
    .card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      padding: 16px 18px 20px;
      box-shadow: 0 14px 45px rgba(0,0,0,0.16), 0 10px 18px rgba(0,0,0,0.12);
      margin-bottom: 16px;
    }
    .title {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    .badge {
      display: inline-block;
      font-size: 0.72rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: #111;
      color: #fff;
      margin-right: 6px;
    }
    .badge.green { background: #2e7d32; }
    .badge.red   { background: #c62828; }
    .badge.orange{ background: #ef6c00; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      padding: 6px 4px;
      text-align: left;
    }
    th {
      border-bottom: 1px solid rgba(0,0,0,0.12);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      opacity: 0.8;
    }
    tr:nth-child(even) td {
      background: rgba(0,0,0,0.03);
    }
    .court-card {
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.7);
      margin-bottom: 8px;
      border: 1px solid rgba(0,0,0,0.08);
    }
    .court-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .small {
      font-size: 0.8rem;
      opacity: 0.8;
    }
    .loading, .error {
      text-align: center;
      padding: 32px 16px;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="root">
      <div class="card loading">Loading Mexicano liveâ€¦</div>
    </div>
  </div>

<script>
  // ðŸ”— Sama projekti kuin iOS-puolella SupabaseManagerissa
  const PROJECT_URL = "https://bxklcpvwtaeklormsdsk.supabase.co";
  const ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4a2xjcHZ3dGFla2xvcm1zZHNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyOTE4MzgsImV4cCI6MjA3ODg2NzgzOH0.bV5-yhGlnHkPBXY_vdirMZjWhPzoiL7OU7txTfexPBA";

  // Hae yksi rivi taulusta "mexicano" id:n perusteella
  async function fetchTournament(id) {
    const url = `${PROJECT_URL}/rest/v1/mexicano?id=eq.${encodeURIComponent(id)}&select=*`;
    const res = await fetch(url, {
      headers: {
        "apikey": ANON_KEY,
        "Authorization": `Bearer ${ANON_KEY}`
      }
    });
    if (!res.ok) throw new Error("Supabase error: " + res.status);
    const data = await res.json();
    return data[0] || null;
  }

  function getQueryId() {
    const p = new URLSearchParams(window.location.search);
    return p.get("id");
  }

  // Laske pm50 jokaiselle pelaajalle rounds + points_per_round -datan perusteella
  function computePlayersWithPm50(row) {
    const ppr = row.points_per_round || 0;
    const players = Array.isArray(row.players) ? row.players : [];
    const rounds  = Array.isArray(row.rounds)  ? row.rounds  : [];

    // Lasketaan montako "kierrosta" kukin pelaaja on pelannut (eli matsien mÃ¤Ã¤rÃ¤)
    const gamesByPlayer = {};
    players.forEach(p => { gamesByPlayer[p.id] = 0; });

    rounds.forEach(r => {
      (r.matches || []).forEach(m => {
        if (typeof m.pointsA === "number") {
          const all = []
            .concat(m.teamA || [])
            .concat(m.teamB || []);
          all.forEach(pid => {
            gamesByPlayer[pid] = (gamesByPlayer[pid] || 0) + 1;
          });
        }
      });
    });

    return players.map(p => {
      const games = gamesByPlayer[p.id] || 0;
      const baseline = (games * ppr) / 2;
      const pm50 = Math.round((p.total || 0) - baseline);
      return {
        id: p.id,
        name: p.name,
        total: p.total || 0,
        pm50: pm50
      };
    });
  }

  function render(root, t) {
    if (!t) {
      root.innerHTML = `
        <div class="card error">
          Turnausta ei lÃ¶ytynyt. Varmista ettÃ¤ linkki on oikein.
        </div>
      `;
      return;
    }

    const playersRaw = Array.isArray(t.players) ? t.players : [];
    const rounds     = Array.isArray(t.rounds)  ? t.rounds  : [];
    const finished   = !!t.finished;

    const pointsPerRound = t.points_per_round ?? "-";
    const courts         = t.courts ?? "-";

    // Pelaajat pm50-arvon kanssa
    const players = computePlayersWithPm50(t);

    // JÃ¤rjestÃ¤ standings total-pisteiden mukaan
    const sortedPlayers = [...players].sort((a, b) => (b.total || 0) - (a.total || 0));

    // Lasketaan "virallinen" kierrosnumero
    const totalRounds = rounds.length;

    let lastPlayedIndex = 0;
    rounds.forEach(r => {
      const hasScore = (r.matches || []).some(m => typeof m.pointsA === "number");
      if (hasScore && typeof r.index === "number" && r.index > lastPlayedIndex) {
        lastPlayedIndex = r.index;
      }
    });

    let currentRoundForLive;
    if (finished) {
      currentRoundForLive = totalRounds || 0;
    } else if (lastPlayedIndex === 0) {
      currentRoundForLive = totalRounds > 0 ? 1 : 0;
    } else if (lastPlayedIndex < (totalRounds || lastPlayedIndex)) {
      currentRoundForLive = lastPlayedIndex + 1;
    } else {
      currentRoundForLive = lastPlayedIndex;
    }

    // Uusin kierros (suurimman index-arvon kierros) â€“ nÃ¤ytetÃ¤Ã¤n KAIKKI sen kentÃ¤t
    let latestRound = null;
    if (rounds.length > 0) {
      latestRound = rounds
        .slice()
        .sort((a, b) => (a.index || 0) - (b.index || 0))
        [rounds.length - 1];
    }

    // Pelaaja-id â†’ nimi map
    const nameById = {};
    playersRaw.forEach(p => {
      if (p.id && p.name) nameById[p.id] = p.name;
    });

    let html = "";

    // HEADER
    html += `
      <div class="card">
        <div class="title">${t.name || "Padel Mexicano"}</div>
        <div class="subtitle">
          Points / round: <b>${pointsPerRound}</b> &bull;
          Courts: <b>${courts}</b> &bull;
          Players: <b>${playersRaw.length}</b>
        </div>
        <div style="margin-bottom: 6px;">
          <span class="badge ${finished ? "green" : "orange"}">
            ${finished ? "Finished" : "Live"}
          </span>
          ${
            totalRounds
              ? `<span class="badge">
                   Rounds: ${Math.max(1, currentRoundForLive)}/${totalRounds}
                 </span>`
              : ""
          }
        </div>
        <div class="small">
          This page updates live when scores are entered in the GonaPadel app.
        </div>
      </div>
    `;

    // STANDINGS
    html += `
      <div class="card">
        <div class="title">Standings</div>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Player</th>
              <th style="text-align:right;">Total</th>
              <th style="text-align:right;">Â±50</th>
            </tr>
          </thead>
          <tbody>
            ${
              sortedPlayers.map((p, idx) => `
                <tr>
                  <td>${idx + 1}</td>
                  <td>${p.name}</td>
                  <td style="text-align:right;">${p.total}</td>
                  <td style="text-align:right;">${p.pm50 >= 0 ? "+" + p.pm50 : p.pm50}</td>
                </tr>
              `).join("")
            }
          </tbody>
        </table>
      </div>
    `;

    // VIIMEISIN KIERROS â€“ nÃ¤ytetÃ¤Ã¤n kaikki kentÃ¤t heti
    if (latestRound && Array.isArray(latestRound.matches)) {
      html += `
        <div class="card">
          <div class="title">Latest round â€“ #${latestRound.index ?? "?"}</div>
          <div class="subtitle">
            ${latestRound.completed ? "Round completed" : "Round in progress"}
          </div>
      `;

      const maxPts = t.points_per_round || 0;

      latestRound.matches.forEach(m => {
        const aNames = (m.teamA || []).map(id => nameById[id] || "Player").join(" & ");
        const bNames = (m.teamB || []).map(id => nameById[id] || "Player").join(" & ");
        const a = m.pointsA;
        const b = (typeof a === "number" && typeof maxPts === "number")
          ? (maxPts - a)
          : null;

        html += `
          <div class="court-card">
            <div class="court-title">
              <span>Court ${ (m.court ?? 0) + 1 }</span>
              <span class="small">${typeof a === "number" ? "Finished" : "Playing"}</span>
            </div>
            <div class="small" style="margin-bottom:4px;">
              ${aNames} vs ${bNames}
            </div>
            <div class="small">
              ${
                (typeof a === "number" && typeof b === "number")
                  ? `<b>${a} â€“ ${b}</b>`
                  : "No score yet"
              }
            </div>
          </div>
        `;
      });

      html += `</div>`;
    }

    root.innerHTML = html;
  }

  (async function main() {
    const root = document.getElementById("root");
    const id = getQueryId();
    if (!id) {
      root.innerHTML = `
        <div class="card error">
          No tournament id in URL.<br/>
          Expected: <code>?id=YOUR_UUID</code>
        </div>
      `;
      return;
    }

    try {
      const t = await fetchTournament(id);
      render(root, t);

      // Pollataan 5 sek vÃ¤lein â€“ halutessa voit muuttaa 3000 ms:ksi
      setInterval(async () => {
        try {
          const updated = await fetchTournament(id);
          render(root, updated);
        } catch (e) {
          console.error("Polling error", e);
        }
      }, 5000);
    } catch (e) {
      console.error(e);
      root.innerHTML = `
        <div class="card error">
          Error loading tournament.<br/>
          ${e.message}
        </div>
      `;
    }
  })();
</script>
</body>
</html>


